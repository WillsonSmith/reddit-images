// Generated by CoffeeScript 1.9.3
(function() {
  var clearImages, container, createImageElement, form, getImagesFromData, getSubredditContent, hashHandler, initialize, putImagesOnScreen, saved_states, search_box, startFormListener, startScrollListener,
    indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

  container = document.getElementById("container");

  form = document.getElementById("subreddit-form");

  search_box = form.getElementsByTagName("input")[0];

  saved_states = {
    last_search: "",
    after_id: null
  };

  clearImages = function() {
    return container.innerHTML = "";
  };

  hashHandler = function() {
    return {
      initialize: function() {
        this.handle();
        return window.addEventListener("hashchange", (function(_this) {
          return function() {
            return _this.handle();
          };
        })(this));
      },
      handle: function(hash) {
        if (hash) {
          return location.hash = hash;
        } else {
          if (location.hash) {
            return getSubredditContent(location.hash.substr(1));
          }
        }
      }
    };
  };

  createImageElement = function(image_array) {
    var container_element, i, image, image_container, image_element, image_link, len;
    container_element = document.createElement("section");
    image_link = document.createElement("a");
    image_container = document.createElement("div");
    image_element = document.createElement("img");
    container_element.classList.add("image-container");
    for (i = 0, len = image_array.length; i < len; i++) {
      image = image_array[i];
      image_link = image_link.cloneNode(false);
      image_container = image_container.cloneNode(false);
      image_element = image_element.cloneNode(false);
      image_container.classList.add("column-item");
      image_link.href = image;
      image_element.src = image;
      image_link.appendChild(image_element);
      image_container.appendChild(image_link);
      container_element.appendChild(image_container);
    }
    return container_element;
  };

  putImagesOnScreen = function(image_array) {
    return container.appendChild(createImageElement(image_array));
  };

  getImagesFromData = function(data) {
    var i, image_links, len, post, post_type, post_url, posts;
    posts = data.data.children;
    image_links = [];
    for (i = 0, len = posts.length; i < len; i++) {
      post = posts[i];
      post_type = post.data.post_hint;
      post_url = post.data.url;
      if (indexOf.call(image_links, post_url) < 0) {
        if (post_type === "image" && post_url) {
          image_links.push(post_url);
        }
      }
    }
    return image_links;
  };

  getSubredditContent = function(subreddit, after) {
    if (after == null) {
      after = "";
    }
    return fetch("https://www.reddit.com/r/" + subreddit + ".json?after=" + after).then(function(response) {
      return response.json();
    }).then(function(data) {
      saved_states.last_search = subreddit;
      if (data.data.after) {
        saved_states.after_id = data.data.after;
      }
      if (!("error" in data)) {
        return putImagesOnScreen(getImagesFromData(data));
      }
    })["catch"](function(error) {
      return console.log(error);
    });
  };

  startFormListener = function() {
    return form.addEventListener("submit", function(e) {
      var subreddit;
      e.preventDefault();
      subreddit = search_box.value;
      if (subreddit) {
        clearImages();
        hashHandler().handle(subreddit);
        return getSubredditContent(subreddit);
      } else {
        return clearImages();
      }
    });
  };

  startScrollListener = function() {
    return window.addEventListener("scroll", function() {
      var client_height, page_Y_offset, scroll_height;
      scroll_height = document.documentElement.scrollHeight;
      page_Y_offset = window.pageYOffset;
      client_height = document.documentElement.clientHeight;
      if (scroll_height - (page_Y_offset + client_height) < 50) {
        return getSubredditContent(saved_states.last_search, saved_states.after_id);
      }
    });
  };

  initialize = function() {
    hashHandler().initialize();
    startFormListener();
    return startScrollListener();
  };

  initialize();

}).call(this);
